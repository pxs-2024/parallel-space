// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider   = "prisma-client"
  output     = "../src/generated/prisma"
  engineType = "client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id           String    @id @default(cuid())
  username     String    @unique
  email        String    @unique
  passwordHash String
  sessions     Session[]
  spaces       Space[]
}

model Session {
  id         String   @id @default(cuid())
  userId     String
  secretHash Bytes
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model Space {
  id          String   @id @default(cuid())
  name        String
  description String
  // 平面图上的区域：网格格点坐标数组 [{x,y}, ...]，必填
  cells       Json     @default("[]")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id])
  userId String

  assets  Asset[]
  actions Action[]

  @@index([userId])
  @@index([createdAt])
}

enum AssetKind {
  STATIC // 静态物品
  CONSUMABLE // 消耗品
  TEMPORAL // 时间性物品
}

enum AssetState {
  ACTIVE // 活跃  正常使用
  PENDING // 待处理 （待补充）
  PAUSED // 暂停 （暂停 不触发提醒）
  DISCARDED // 丢弃 （放入垃圾桶）
}

model Asset {
  id String @id @default(cuid())

  spaceId String
  space   Space  @relation(fields: [spaceId], references: [id])

  name        String
  description String?
  kind        AssetKind  @default(STATIC)
  state       AssetState @default(ACTIVE)
  isDeleted   Boolean    @default(false)


  // 消耗型
  quantity             Int? // 物品数量
  unit                 String? // 单位
  reorderPoint         Int? // 数量减到时触发提醒
  consumeIntervalDays  Int? // 消耗周期：每隔多少天消耗一次
  consumeAmountPerTime Int? // 每次消耗数量

  // 时间型
  dueAt      DateTime? // 过期时间 （过期性物品）
  lastDoneAt DateTime? // 上次改动时间
  nextDueAt  DateTime? // 下次到期时间

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  actions          Action[]

  @@index([spaceId])
  @@index([spaceId, isDeleted])
  @@index([kind, nextDueAt])
  @@index([spaceId, kind, nextDueAt])
}

enum ActionType {
  RESTOCK // 补充物品
  NEW_ASSET // 新增物品 （用于 AI 建议）
}

enum ActionStatus {
  OPEN // 未处理
  DONE // 已处理
}

model Action {
  id String @id @default(cuid())

  spaceId String
  space   Space  @relation(fields: [spaceId], references: [id])

  assetId String?
  asset   Asset?  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  type   ActionType
  status ActionStatus @default(OPEN)

  dueAt DateTime?
  key   String?

  payload Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([key])
  @@index([spaceId, status, dueAt])
  @@index([assetId, status, dueAt])
  @@index([type, status, dueAt])
}

# 平行空间（Parallel Space）

规则驱动的个人资产管理：用可视化画布把「物品 / 资产」与「待办」连起来，在需要时提醒你。

> 核心价值：**让“我拥有的东西”，在需要我决策之前提醒我。**

**技术栈**：Next.js 16 (App Router) + React 19 + TypeScript + Tailwind CSS 4 / shadcn/ui + Prisma（client + pg adapter）+ PostgreSQL，Session + Argon2 登录，next-intl 中英国际化，Vercel Cron 定时生成待办。画布拖拽（dnd-kit）、URL 状态（nuqs）、Toast（sonner）、日期选择（react-day-picker / date-fns）等。

---

## 快速开始

```bash
pnpm install
cp .env.example .env   # 配置 DATABASE_URL、DIRECT_URL
pnpm prisma db push
pnpm prisma-generate   # 或依赖 postinstall 自动执行
pnpm dev
```

浏览器打开 [http://localhost:3000](http://localhost:3000)。未登录访问首页会跳转登录；注册/登录后使用。

**可选**：`pnpm prisma-seed` 填充示例数据（用户、平面图户型空间、多物品、待办与历史记录）。

---

## 主要功能

### 待办（Todo）

- **入口**：侧栏「待办」。
- 系统按规则生成的待处理事项：**补货**（消耗型数量 ≤ 补货点）、**选择到期时间**（时间型临近到期）、**待丢弃**（消耗型数量为 0）、**新增物品**（AI 建议采纳后待选空间入库）等。
- **操作**：补充数量、选择到期时间（shadcn 日历）、确认丢弃、忽略（一天/一周/一月）；新增物品类需选择目标空间后完成。处理后有 Toast 提示。
- 待办由 **每日定时任务**（Vercel Cron 调用 `/api/cron/process-decisions`）统一生成，页面仅拉取数据。

### 物品管理（Spaces）

- **入口**：侧栏「物品管理」。
- **平面图**：主区域为**平面图画布**，每个空间为一块可点击的格点区域。支持「编辑」模式：框选绘制/修改空间形状、右键「编辑空间」「编辑信息」或「删除空间」（删除前有确认，会一并删除该空间内物品）；使用模版一键生成户型、生成图形（圈选后创建新空间）；点「完成」提交变更，校验空间区域必须连通。
- **空间**：需手动创建或使用模版生成（无默认空间）。
- **视图**：点击某空间后滑出**空间物品抽屉**，内为该空间物品卡片列表；支持新建物品、收起抽屉。
- **物品操作**：点击物品卡片在抽屉内打开**详情**，可编辑名称、描述、单位/补货线/消耗周期/到期等（按类型展示）。在物品卡片上**右键**可打开菜单：「移入其他空间」子菜单选择目标空间、「删除物品」（确认弹窗后硬删除，并删除关联待办）。
- **搜索**：画布旁悬浮搜索按钮，打开为**全局物品搜索**（筛选、分页、跳转空间）。

### AI 建议（AI Suggestions）

- **入口**：侧栏「AI建议」。
- **按空间推荐清单**：页面展示按空间划分的基础生活物品清单（入口、客厅、厨房等），供参考。
- **获取建议**：点击「获取 AI 建议」后，系统根据当前空间与物品计算缺口，按空间逐条展示推荐补充项；可「采纳」（加入待办）或「忽略」，完成后可到待办页确认。

### 账户

- 侧栏「个人资料」：修改用户名等；「密码」：修改密码。
- 登录/注册页支持语言切换（中/英）与主题切换。

---

## 各页面操作说明

以下说明与当前项目界面、文案一致，按实际操作路径编写。

### 待办页（/todo）

| 操作 | 说明 |
|------|------|
| 进入页面 | 侧栏点击「待办」。列表为待处理事项（补货、到期、待丢弃、新增物品等）。 |
| 搜索 | 顶部搜索框输入后防抖筛选。 |
| 筛选 | 按类型、时间等筛选（与 URL 同步）。 |
| 补充数量 | 补货类卡片：点击「已补充」或输入数量后确认，成功后有 Toast。 |
| 选择到期时间 | 时间型到期类：点击「选择到期时间」→ 日历选日 → 确认更新或取消。 |
| 确认丢弃 | 待丢弃类：点击「确认丢弃」。 |
| 新增物品（待买） | 来自 AI 建议采纳的项：选择目标空间后完成，系统在该空间创建物品并关闭待办。 |
| 忽略 | 单条可忽略（一天/一星期/一个月）；支持批量忽略。 |

### 物品管理页（/spaces）

| 操作 | 说明 |
|------|------|
| 进入页面 | 侧栏点击「物品管理」。主内容为**平面图画布**，格点上绘制各空间区域，左上角显示当前「移动」/「选择」状态。 |
| 编辑 / 完成 | 右上角「编辑」进入编辑模式；编辑下可框选、使用模版、生成图形、保存图形；点「完成」提交所有变更并退出编辑。 |
| 新建空间 | 编辑模式下：选择工具框选区域 → 点「生成图形」→ 弹窗填写名称、描述 → 创建；或点「使用模版」选户型，悬浮预览、确认后一键生成多个空间（生成在视口中心）。 |
| 修改空间 | 编辑模式下在某一**空间区域**上**右键** →「编辑空间」→ 可框选调整形状，点「保存图形」确认（需连通）；或「编辑信息」改名称、描述。 |
| 删除空间 | 编辑模式下在空间区域上**右键** →「删除空间」→ 确认弹窗提示会一并删除该空间内物品 → 确认后执行。 |
| 打开空间抽屉 | **点击**某块空间区域（非编辑时），滑出该空间的**物品抽屉**，内为物品卡片列表。 |

### 底部抽屉（当前空间物品）

| 操作 | 说明 |
|------|------|
| 收起 | 标题右侧「收起」关闭抽屉。 |
| 新建物品 | 标题右侧「新建物品」打开创建弹窗，按步骤填写名称、描述、类型（静态/消耗型/时间型），时间型可设过期时间（shadcn 日历 + 时间）。 |
| 打开物品详情 | **点击**某张物品卡片，在抽屉内打开该物品详情，可编辑名称、描述、单位/补货线/消耗周期/到期等（按类型展示），保存后有 Toast。 |
| 移入其他空间 | 在物品卡片上**右键** →「移入其他空间」→ 子菜单选择目标空间（若无其他空间则显示「暂无其他空间」且不可选），执行后物品移至目标空间并关闭抽屉。 |
| 删除物品 | 物品卡片**右键** →「删除物品」（红色）→ 确认弹窗后硬删除，并删除关联待办。 |

### 全局搜索（右侧面板）

| 操作 | 说明 |
|------|------|
| 打开/关闭 | 点击页面右侧悬浮的**搜索图标**按钮打开面板；面板内有关闭按钮可关闭。 |
| 筛选与搜索 | 搜索框（占位符「搜索名称或描述...」）、搜索、重置；可筛空间、种类（全部种类/静态/消耗型/时间型）、状态、排序等，与 URL 同步。 |
| 跳转空间 | 列表中点击某条物品，会跳转到该物品所在空间并打开底部抽屉。 |
| 分页 | 底部有上一页、下一页及页数信息。 |

### AI 建议页（/ai-suggestions）

| 操作 | 说明 |
|------|------|
| 进入页面 | 侧栏点击「AI建议」。页面展示「按空间推荐清单」与「获取 AI 建议」入口。 |
| 按空间推荐清单 | 以卡片形式展示各空间（入口、客厅、厨房等）及对应推荐物品列表，供参考。 |
| 获取 AI 建议 | 点击「获取 AI 建议」→ 弹窗内按空间逐条展示推荐补充项（缺 N、采纳/忽略）；可「采纳」加入待办或「忽略」；完成后可到待办页确认。 |

### 账户相关

| 页面 | 操作 |
|------|------|
| 个人资料 | 侧栏「个人资料」→ 表单：用户名、邮箱 →「保存」。成功有 Toast。 |
| 密码 | 侧栏「密码」→ 当前密码、新密码（至少 6 位）、确认新密码 →「修改密码」。 |
| 语言 / 主题 | 登录页或顶栏可切换语言（中/英）、主题（亮/暗）。 |

---

## 环境与部署

- **数据库**：PostgreSQL；Prisma 使用 `engineType = "client"` + `@prisma/adapter-pg`，无需平台二进制，适合 Vercel 等 Serverless。
- **环境变量**：`DATABASE_URL`、`DIRECT_URL`（见 `.env.example`）。
- **Vercel**：`vercel.json` 已配置 Cron，每日触发 `/api/cron/process-decisions`（默认 `0 16 * * *`，UTC 16:00）。

---

## 常用命令

| 命令 | 说明 |
|------|------|
| `pnpm dev` | 开发服务器 |
| `pnpm build` / `pnpm start` | 构建与生产运行 |
| `pnpm type` | TypeScript 检查 |
| `pnpm prisma db push` | 同步数据库 schema |
| `pnpm prisma-generate` | 生成 Prisma Client |
| `pnpm prisma-seed` | 填充种子数据（用户、平面图空间、物品、待办与历史） |

更细的产品与规则说明见 [docs/PRODUCT.md](docs/PRODUCT.md)。

---
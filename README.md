# 平行空间（Parallel Space）

规则驱动的个人资产管理：用可视化画布把「物品 / 资产」与「待办」连起来，在需要时提醒你。

> 核心价值：**让“我拥有的东西”，在需要我决策之前提醒我。**

**技术栈**：Next.js 16 (App Router) + React 19 + TypeScript + Tailwind CSS 4 / shadcn/ui + Prisma（client + pg adapter）+ PostgreSQL，Session + Argon2 登录，next-intl 中英国际化，Vercel Cron 定时生成待办。画布拖拽（dnd-kit）、URL 状态（nuqs）、Toast（sonner）、日期选择（react-day-picker / date-fns）等。

---

## 快速开始

```bash
pnpm install
cp .env.example .env   # 配置 DATABASE_URL、DIRECT_URL
pnpm prisma db push
pnpm prisma-generate   # 或依赖 postinstall 自动执行
pnpm dev
```

浏览器打开 [http://localhost:3000](http://localhost:3000)。未登录访问首页会跳转登录；注册/登录后使用。

**可选**：`pnpm prisma-seed` 填充示例数据（多空间、多物品、网格布局、待办与历史记录）。

---

## 主要功能

### 待办（Todo）

- **入口**：侧栏「待办」。
- 系统按规则生成的待处理事项：**补货**（消耗型数量 ≤ 补货点）、**选择到期时间**（时间型/虚拟型临近到期）、**待丢弃**（消耗型数量为 0）等。
- **操作**：补充数量、选择到期时间（shadcn 日历）、确认丢弃、忽略（一天/一周/一月）；支持批量忽略。处理后有右下角 Toast 提示。
- 待办由 **每日定时任务**（Vercel Cron 调用 `/api/cron/process-decisions`）统一生成，页面仅拉取数据。

### 物品管理（Spaces）

- **入口**：侧栏「物品管理」→ 空间列表。
- **空间**：需手动创建（无默认空间）。支持新建/编辑空间、拖拽排序。
- **视图**：进入某空间后为**画布视图**；底部可拉出**抽屉**查看该空间物品列表，支持移动/删除、保存布局。画布高度超过阈值时顶部会滑出**空间条**，可快速切换空间。
- **搜索**：右侧悬浮搜索按钮，打开后为**全局物品搜索**（筛选、分页、跳转空间）。

### 资产（Asset）

- **画布**：在底部抽屉内，点「修改布局」后可拖拽物品卡片排布，再点「保存布局」批量写入位置；画布支持缩放与平移。
- **详情**：点击物品卡片在抽屉内打开详情，可编辑名称、描述、信息卡颜色等；右键卡片可「移动至」其他空间或「删除」。

### 历史记录（History）

- **入口**：侧栏「历史记录」。
- 展示用户操作（补货、更新、丢弃等）与自动消耗记录，按时间列表展示。

### 账户

- 侧栏「个人资料」：修改用户名等；「密码」：修改密码。
- 登录/注册页支持语言切换（中/英）与主题切换。

---

## 各页面操作说明

以下说明与当前项目界面、文案一致，按实际操作路径编写。

### 待办页（/todo）

| 操作 | 说明 |
|------|------|
| 进入页面 | 侧栏点击「待办」。列表为待处理事项，每条前有复选框。 |
| 搜索 | 顶部搜索框占位符为「搜索空间或资产」，输入后防抖筛选。 |
| 筛选 | **类型**下拉：全部类型、补充、到期、待丢弃。**时间**下拉：全部时间、已过期、本周内、本月内。 |
| 全选/批量忽略 | 「全选当前页」/「取消全选」勾选当前筛选结果；「批量忽略（今日）」对已勾选项执行忽略，按钮上会显示已选数量。 |
| 补充数量 | 卡片为「您的 xxx 已需补货，是否补充？」时，点击「补充（填数量）」→ 输入数量（单位按物品）→「确定」或「取消」。成功后有 Toast。 |
| 选择到期时间 | 卡片为「您的 xxx 已到期，是否更新？」时，点击「选择到期时间」→ 弹出日历，点击「选择日期」选日 →「更新」或「取消」。 |
| 确认丢弃 | 卡片为「您的 xxx 待丢弃，是否丢弃？」时，点击「确认丢弃」。 |
| 单条忽略 | 点击「忽略」下拉：忽略一天、忽略一星期、忽略一个月。 |

### 物品管理页（/spaces）

| 操作 | 说明 |
|------|------|
| 进入页面 | 侧栏点击「物品管理」。主内容为空间卡片列表，可拖拽卡片改变顺序（松手后请求保存）。 |
| 新建空间 | 在**列表空白区域**（非卡片上）右键 → 弹出菜单「新建空间」→ 弹窗填写「空间名称 *」「空间描述（可选）」→「创建」或「取消」。 |
| 修改空间 | 在某一**空间卡片**上右键 →「修改空间」→ 弹窗修改名称、描述 →「保存」或「取消」。 |
| 打开空间抽屉 | **点击**某张空间卡片（非拖拽），底部滑出该空间的**物品抽屉**，内为画布 + 物品卡片。 |

### 底部抽屉（当前空间物品）

| 操作 | 说明 |
|------|------|
| 调整高度 | 抽屉顶部有一条横条（无障碍：拖动调整高度），按住上下拖可改变抽屉高度。 |
| 修改布局 / 保存布局 | 标题右侧先点「修改布局」，再在画布上拖拽物品卡片排布，最后点「保存布局」持久化；未点保存前为「修改布局」。 |
| 收起 | 标题右侧「收起」关闭抽屉。 |
| 画布 | 支持平移、缩放；仅在「修改布局」状态下可拖拽卡片。 |
| 打开物品详情 | **点击**某张物品卡片（非拖拽），在抽屉内打开该物品详情，可编辑名称、描述、信息卡颜色等，保存后有 Toast。 |
| 移动至其他空间 | 在物品卡片上**右键** →「移动至」→ 子菜单选择目标空间名称（若无其他空间则显示「暂无其他空间」且不可选）。 |
| 删除物品 | 物品卡片右键 →「删除」（红色），执行后为软删除。 |

### 顶部空间条

当**底部抽屉**拉高到约一半屏以上时，页面顶部会滑出空间条，可左右滑动或点击空间名切换当前空间，无需先收起抽屉。

### 全局搜索（右侧面板）

| 操作 | 说明 |
|------|------|
| 打开/关闭 | 点击页面右侧悬浮的**搜索图标**按钮打开面板；面板内第一行右侧有关闭按钮可关闭。 |
| 筛选与搜索 | 第一行有搜索框（占位符「搜索名称或描述...」）、搜索、重置；可筛空间、种类（全部种类/静态/消耗型/时间型/虚拟型）、状态、排序等，与 URL 同步。 |
| 跳转空间 | 列表中点击某条物品，会跳转到该物品所在空间并打开底部抽屉；列表项右键为「跳转空间」。 |
| 分页 | 底部有上一页、下一页及页数信息。 |

### 账户相关

| 页面 | 操作 |
|------|------|
| 个人资料 | 侧栏「个人资料」→ 表单：用户名、邮箱 →「保存」。成功有 Toast。 |
| 密码 | 侧栏「密码」→ 当前密码、新密码（至少 6 位）、确认新密码 →「修改密码」。 |
| 语言 / 主题 | 登录页或顶栏可切换语言（中/英）、主题（亮/暗）。 |

---

## 环境与部署

- **数据库**：PostgreSQL；Prisma 使用 `engineType = "client"` + `@prisma/adapter-pg`，无需平台二进制，适合 Vercel 等 Serverless。
- **环境变量**：`DATABASE_URL`、`DIRECT_URL`（见 `.env.example`）。
- **Vercel**：`vercel.json` 已配置 Cron，每日触发 `/api/cron/process-decisions`（默认 `0 16 * * *`，UTC 16:00）。

---

## 常用命令

| 命令 | 说明 |
|------|------|
| `pnpm dev` | 开发服务器 |
| `pnpm build` / `pnpm start` | 构建与生产运行 |
| `pnpm type` | TypeScript 检查 |
| `pnpm prisma db push` | 同步数据库 schema |
| `pnpm prisma-generate` | 生成 Prisma Client |
| `pnpm prisma-seed` | 填充种子数据（多空间、网格布局物品、待办与历史） |

更细的产品与规则说明见 [docs/PRODUCT.md](docs/PRODUCT.md)。
